<%# _song.html.erb - Renders a single song in a collapsible component %>
<div class="grid grid-cols-1">
  <!-- Details/Summary element -->
  <div class="col-start-1 row-start-1">
    <details
      class="group collapse bg-base-100 border border-base-300 rounded-xl transition duration-200 hover:border-primary/60 hover:shadow-sm">
      <summary class="collapse-title list-none cursor-pointer">
        <div class="flex items-center justify-between">
          <span class="font-semibold text-primary truncate pr-2 max-w-[60%] md:max-w-[70%]"><%= song.title %></span>
        </div>
      </summary>
      <div class="collapse-content pt-0">
        <article class="prose max-w-none break-words mt-2">
          <%= simple_format song.content %>
        </article>
      </div>
    </details>
  </div>

  <!-- Action buttons - overlaid on same grid cell -->
  <div class="col-start-1 row-start-1 flex justify-end items-start gap-1 md:gap-2 p-4 pointer-events-none z-10">
    <% if song.content.present? %>
      <span class="btn btn-xs btn-outline btn-accent pointer-events-none flex items-center gap-1">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
          <polyline points="14 2 14 8 20 8"></polyline>
          <line x1="16" y1="13" x2="8" y2="13"></line>
          <line x1="16" y1="17" x2="8" y2="17"></line>
          <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
        <span class="hidden md:inline">Letra</span>
      </span>
    <% end %>

    <% if song.video_links.any? %>
      <button
        class="btn btn-xs btn-outline btn-success pointer-events-auto flex items-center gap-1"
        onclick="window.dispatchEvent(new CustomEvent('play-song', { detail: { songId: <%= song.id %> } }))"
        type="button">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="hidden md:inline">Escuchar</span>
      </button>
    <% end %>

    <% if song.chordpro_content.present? %>
      <button
        class="btn btn-xs btn-outline btn-primary pointer-events-auto flex items-center gap-1"
        onclick="chords_modal_<%= song.id %>.showModal()"
        type="button">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18V5l12-2v13"></path>
          <circle cx="6" cy="18" r="3"></circle>
          <circle cx="18" cy="16" r="3"></circle>
        </svg>
        <span class="hidden md:inline">Acordes</span>
      </button>
    <% end %>

    <% if song.video_links.any? %>
      <button
        class="btn btn-xs btn-outline btn-secondary pointer-events-auto flex items-center gap-1"
        onclick="video_modal_<%= song.id %>.showModal()"
        type="button">
        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
          <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
        </svg>
        <span class="hidden md:inline">Video</span>
      </button>
    <% end %>
  </div>
</div>

<!-- Chords Modal -->
<% if song.chordpro_content.present? %>
  <dialog id="chords_modal_<%= song.id %>" class="modal">
    <div class="modal-box max-w-4xl w-full">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>

      <h3 class="font-bold text-lg mb-4 text-base-content"><%= song.title %> - Acordes</h3>

      <!-- ChordPro Preview Container -->
      <div data-controller="chordpro-preview">
        <textarea
          style="display: none;"
          data-chordpro-preview-target="input"><%= song.chordpro_content %></textarea>

        <div
          data-chordpro-preview-target="preview"
          class="chordpro-modal-preview">
          <!-- ChordPro content will be rendered here -->
        </div>
      </div>

      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-primary">Cerrar</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
<% end %>

<!-- Video Modal -->
<% if song.video_links.any? %>
  <dialog id="video_modal_<%= song.id %>" class="modal">
    <div class="modal-box max-w-5xl w-full">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
      </form>

      <h3 class="font-bold text-lg mb-4 text-base-content"><%= song.title %> - Videos</h3>

      <div class="space-y-4">
        <% song.video_links.each do |video_link| %>
          <div class="w-full" style="aspect-ratio: 16/9; min-height: 400px;">
            <% if video_link.provider_youtube? %>
              <iframe
                class="video-iframe"
                width="100%"
                height="100%"
                data-src="https://www.youtube.com/embed/<%= video_link.video_id %>"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen>
              </iframe>
            <% elsif video_link.provider_vimeo? %>
              <iframe
                class="video-iframe"
                width="100%"
                height="100%"
                data-src="https://player.vimeo.com/video/<%= video_link.video_id %>"
                frameborder="0"
                allow="autoplay; fullscreen; picture-in-picture"
                allowfullscreen>
              </iframe>
            <% end %>
          </div>
        <% end %>
      </div>

      <div class="modal-action">
        <form method="dialog">
          <button class="btn btn-primary">Cerrar</button>
        </form>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <script>
    (function() {
      const modal = document.getElementById('video_modal_<%= song.id %>');
      if (modal) {
        // Load iframes when modal opens
        const openButton = document.querySelector('[onclick="video_modal_<%= song.id %>.showModal()"]');
        if (openButton) {
          openButton.addEventListener('click', function() {
            const iframes = modal.querySelectorAll('.video-iframe');
            iframes.forEach(iframe => {
              if (iframe.dataset.src && !iframe.src) {
                iframe.src = iframe.dataset.src;
              }
            });
          });
        }

        // Unload iframes when modal closes
        modal.addEventListener('close', function() {
          const iframes = this.querySelectorAll('.video-iframe');
          iframes.forEach(iframe => {
            iframe.src = '';
          });
        });
      }
    })();
  </script>
<% end %>
